# 第一章 楔子

编程语言是一种记法。一方面，它为人类描述算法；另一方面，它为机器描述算法。我们这个世界已经非常依赖编程语言，每台计算机跑的软件，都是用编程语言编写的。编写的软件程序，需要先翻译，然后才能执行。

翻译也是由一套软件程序完成的，我们称为编译器。

本书讲解如何设计和实现编译器。我们在书中的一些思想，可以为许多语言和机器构建翻译。此外，编译器的设计思想和技巧，也能为计算机科学家的职业生涯提供莫大帮助。编译器的研究，涉及到编程语言、机器架构、语言原理、算法和软件工程。

在本章中，我们介绍几种不同的语言翻译，描述经典编译器的结构，并讨论下编程语言和机器架构的发展趋势。另外，我们还会介绍编译器设计和计算机科学理论的关系，以及编译器技术的应用，这些都超出了编译器的范畴。最后，我们对关键概念作一个简要概括，相信这能有助于我们学习。

## 语言处理器

简单来讲，编译器是一个程序，它读取一种语言（源语言）编写的程序，然后翻译成另一种语言（目标语言）的程序。编译器一个很重要的职责，是在翻译过程检查源程序的正确性，发现错误时，立刻报告：

```?
                             源程序
                               |
                               v
                          +---------+
                          |  编译器  |
                          +---------+
                               |
                               v
                            目标程序
```

当目标程序是一个可执行的机器语言程序时，我们就能运行它。它读取输入，生成输出：

```?
                          ＋----------＋
              输入  ---->  |  目标程序  |  ---->  输出
                          ＋----------＋
```

另一种常见的语言处理器是解释器。它不把源程序翻译为目标程序，而是直接执行源程序，读取输入，生成输出：

```? 
             源程序 ---->  ＋----------＋
              输入  ---->  |   解释器   |  ---->  输出
                          ＋----------＋
```

通常，编译器生成的机器语言目标程序要比解释器映射快得多。不过，解释器更容易调试错误，因为，它是一句一句执行源程序的。

**例子 1.1** Java 语言处理器，由编译和解释组成。Java 写的源程序，首先编译成中间程序（称为字节码），然后，通过虚拟机解释字节码。这样做的好处是：一台机器上编译的字节码，可以在任一台机器上解释，甚至通过网络：

```?
            源程序
              |
              v
         +---------+
         |  翻译器  |
         +---------+
              |
              v
           中间程序  ---->  +----------＋
              输入  ---->  |   虚拟机   |  ---->  输出
                          ＋----------＋
```

为了获得更快的输入到输出的速度，一些 Java 编译器（称为 just-in-time 编译器），在中间程序被解释前，先将其翻译成机器语言。

为了完成一个可执行目标程序，除了需要编译器，还需要其它几个程序。源文件应该分成模块，分别存储在文件中。集合源程序这些文件的任务，委托给一个程序，称为预处理器。预处理器也包含了一些扩展，可以直接用在源语言中，称为宏。经过修改后的源程序，一起传送给编译器。然后，编译器生成汇编语言程序---汇编语言更容易生成、也更容易调试。之后，汇编器处理汇编语言程序，生成可重装的机器码。大型程序，通常是分散编译的，可重装的机器码可以更容易地链接其它可重装的对象文件和库文件。链接器负责解析外部存储器地址－－－一个文件的代码，可能涉及到另一个文件。加载器把所有可执行对象文件放入内存，然后执行。图示：

```？
                             源程序
                               |
                               v
                         +----------＋
                         |  预处理器  |
                         +----------＋
                               |
                               v
                          修改后的源程序
                               |
                               v
                         +-----------+
                         |   编译器   |
                         +-----------+
                               |
                               v
                          　目标汇编程序
                               |
                               v
                         +-----------+
                         |  　汇编器   |
                         +-----------+
                               |
                               v
                          　可重装机器码
                               |
                               v
                      +-----------------＋　　　　　　　　　库文件
                      |   链接器、加载器   |  <----  　
                      +-----------------＋　　　　　　　　　可重装对象文件
                               |
                               v
                          　目标机器码
```

## 编译器的结构

在这里，我们把编译器简单的作为一个沙盒来考虑---进入源程序，出来目标程序。我们把这个盒子打开一点，发现这个过程由两部分组成：分析和合成。

分析部分，把源程序分解成片段，以这些片段构建一个语法结构。然后，用这个结构创建源程序的中间表示。如果检查到源程序存在句法错误或语义不正确，它必须提供有利的消息，以便用户纠正这些问题。另外，它还收集源程序的信息，将其存储到一个数据结构---称为符号表，之后，随中间表示一起传递给合成部分。

合成部分，用中间表示和符号表构建目标程序。通常，分析部分称为前端，合成部分称为后端。

如果我们仔细查看编译过程的细节，会发现它是一系列阶段操作，每一阶段把源程序的一种表示转换为另一种。实际上，几个阶段可以组合到一起，组合后不需要显式地构造中间表示。符号表，保存了整个源程序的信息，编译器的每个阶段都会用到它。图示：

```？
                             　字符流
                             　  |
                             　  v
                     　+--------------------＋
                     　|      词法分析器      |
                     　+--------------------＋
                             　  |
                             　  v
                             　记号流
                             　  |
                             　  v
                     　+--------------------＋
                     　|      语法分析器      |
                     　+--------------------＋
                             　  |
                             　  v
                             　语法树
                             　  |
                             　  v
                     　+--------------------＋
                     　|      语义分析器      |
                     　+--------------------＋
                             　  |
                             　  v
                             　语法树
                             　  |
    +---------+              　  v
    |         |      　+---------------------+
    |  符号表  |      　|    中间代码生成器     |
    |         |      　+---------------------+
    +---------+               　 |
                              　 v
                          　  中间表示
                              　 |
                              　 v
                     　+---------------------+
                     　|  机器无关的代码优化器  |
                     　+---------------------+
                              　 |
                              　 v
                          　 　中间表示
                              　 |
                              　 v
                     　+--------------------＋
                     　|      语义分析器      |
                     　+--------------------＋
                             　  |
                             　  v
                           　目标机器代码
                               　|
                               　v
                     　+---------------------+　
                     　|  机器相关的代码优化器  |
                     　+---------------------+　
                               　|
                               　v
                          　　目标机器代码
```

有些编译器，在前端和后端之间，有一个机器无关的优化阶段。优化阶段的目的，是对中间表示执行一个转换，使后端能生成更好的目标程序－－－如果不这么做，则中间表示没有经过优化。优化是可选的，可以没有这个阶段。

